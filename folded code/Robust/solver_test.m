clear;
clc;


import casadi.*
Nbus = 9;
Nbranch = 9;
Ngen = 3;
Npq = 3;

v_u = MX.sym('v_u', Nbus, 1);
v_l = MX.sym('v_l', Nbus, 1);
Delta_v_u = MX.sym('Delta_v_u', Nbus, 1);
Delta_v_l = MX.sym('Delta_v_l', Nbus, 1);
Phi_u = MX.sym('Phi_u', Nbranch, 1);
Phi_l = MX.sym('Phi_l', Nbranch, 1);
Delta_Phi_u = MX.sym('Delta_Phi_u', Nbranch, 1);
Delta_Phi_l = MX.sym('Delta_Phi_l', Nbranch, 1);

delta_u = MX.sym('delta_u');
delta_l = MX.sym('delta_l');
Ddelta_u = MX.sym('Ddelta_u');
Ddelta_l = MX.sym('Ddelta_l');

g_u_pinj = MX.sym('g_u_pinj', Nbus, 1);
g_l_pinj = MX.sym('g_l_pinj', Nbus, 1);
g_u_qinj = MX.sym('g_u_qinj', Nbus, 1);
g_l_qinj = MX.sym('g_l_qinj', Nbus, 1);
g_u_vvsin = MX.sym('g_u_vvsin', Nbranch, 1);
g_l_vvsin = MX.sym('g_l_vvsin', Nbranch, 1);
g_u_vvcos = MX.sym('g_u_vvcos', Nbranch, 1);
g_l_vvcos = MX.sym('g_l_vvcos', Nbranch, 1);
g_u_vv = MX.sym('g_u_vv', Nbus, 1);
g_l_vv = MX.sym('g_l_vv', Nbus, 1);

Psi_u_vvcos = MX.sym('Psi_u_vvcos', Nbranch, 1);
Psi_l_vvcos = MX.sym('Psi_l_vvcos', Nbranch, 1);
Psi_u_vvsin = MX.sym('Psi_u_vvsin', Nbranch, 1);
Psi_l_vvsin = MX.sym('Psi_l_vvsin', Nbranch, 1);
Psi_u_vv = MX.sym('Psi_u_vv', Nbus, 1);
Psi_l_vv = MX.sym('Psi_l_vv', Nbus, 1);

Delta_vv_u_uu = MX.sym('Delta_vv_u_uu', Nbranch, 1);
Delta_vv_u_ll = MX.sym('Delta_vv_u_ll', Nbranch, 1);
Delta_vv_u_ul = MX.sym('Delta_vv_u_ul', Nbranch, 1);
Delta_vv_u_lu = MX.sym('Delta_vv_u_lu', Nbranch, 1);
Delta_vv_l_uu = MX.sym('Delta_vv_l_uu', Nbranch, 1);
Delta_vv_l_ll = MX.sym('Delta_vv_l_ll', Nbranch, 1);
Delta_vv_l_ul = MX.sym('Delta_vv_l_ul', Nbranch, 1);
Delta_vv_l_lu = MX.sym('Delta_vv_l_lu', Nbranch, 1);

Delta_cos_u_u = MX.sym('Delta_cos_u_u', Nbranch, 1);
Delta_cos_u_l = MX.sym('Delta_cos_u_l', Nbranch, 1);
Delta_cos_l_u = MX.sym('Delta_cos_l_u', Nbranch, 1);
Delta_cos_l_l = MX.sym('Delta_cos_l_l', Nbranch, 1);
Delta_sin_u_u = MX.sym('Delta_sin_u_u', Nbranch, 1);
Delta_sin_u_l = MX.sym('Delta_sin_u_l', Nbranch, 1);
Delta_sin_l_u = MX.sym('Delta_sin_l_u', Nbranch, 1);
Delta_sin_l_l = MX.sym('Delta_sin_l_l', Nbranch, 1);

p_line_fr_u = MX.sym('p_line_fr_u', Nbranch, 1);
q_line_fr_u = MX.sym('q_line_fr_u', Nbranch, 1);
p_line_to_u = MX.sym('p_line_to_u', Nbranch, 1);
q_line_to_u = MX.sym('q_line_to_u', Nbranch, 1);

pg_opt = MX.sym('pg_opt', Ngen, 1);
pl_opt = MX.sym('pl_opt', Npq, 1);
ql_opt = MX.sym('ql_opt', Npq, 1);
pg_opt_u = MX.sym('pg_opt_u', Ngen, 1);
alpha_opt = MX.sym('alpha_opt', Ngen, 1);
Dalpha_opt = MX.sym('Dalpha_opt', Ngen, 1);

cost_opt = MX.sym('cost_opt');
gamma_opt = MX.sym('gamma_opt');
slack_pg = MX.sym('slack_pg');
slack_qg = MX.sym('slack_qg');
slack_line = MX.sym('slack_line');
margin_opt = MX.sym('margin_opt');

v0 = [1.1000000109414008
 1.094221526564359
 1.1000000104467251
 1.0844485060682154
 1.0973546346283134
 1.10000001093974
 1.0894894953060847
 1.0717554590319318
 1.0866203134950396];
Phi0 = [  0.04298613355236408
  0.02651256813891152
 -0.08002110237682468
  0.046192799556568576
  0.03140128691352668
 -0.036685167135829824
 -0.06960391679032354
  0.09635738915693493
 -0.037564974696718614];
vmin =0.9*eye(9,1);
vmax =1.1*eye(9,1);
Phi_min =  -1.0472*eye(9,1);
Phi_max =  1.0472*eye(9,1);

id_gen =[ 3
 5
 9];

delta0 = 0;
alpha0 =[ 1.0
 0.0
 0.0];

% inequality constraints 
idx_fr = [ 3
 2
 4
 9
 6
 7
 1
 1
 8];
idx_to =[ 2
 4
 6
 6
 7
 1
 5
 8
 2];



% >= Ïˆ_vvcos0
Psi_vvcos0 = [ 1.2025318108528649
 1.186209874542341
 1.1890761332481925
 1.1940073518259882
 1.197847650685189
 1.1976321170653557
 1.2041672925131643
 1.1734622122155944
 1.171910550539729];
onoff_pq = [ 1.0
 1.0
 0.0
 1.0
 0.0
 1.0
 1.0
 1.0
 0.0];

% >= Psi_vvsin0
Psi_vvsin0 = [  0.05172405564994723
  0.031456840979702
 -0.09535480083848591
  0.055193804906218655
  0.03762632560187685
 -0.04395505441033826
 -0.08395037544462425
  0.11342300714101042
 -0.04404350912678345];





% <= Psi_vv0
Psi_vv0 = [ 1.2100000240710818
 1.197320749196836
 1.2100000229827954
 1.1760285623135842
 1.2041871941402391
 1.2100000240674282
 1.1869873603823073
 1.148659763964747
 1.1807437057000583];


Cg = sparse([3, 5, 9], [1, 2, 3], [1.0, 1.0, 1.0], 9, 3);
Cl = sparse([4, 7, 8], [1, 2, 3], [1.0, 1.0, 1.0], 9, 3);
pg_max = [ 2.5
 3.0
 2.7];
pg_min = [ 0.1
 0.1
 0.1];

zeta = [0;0;0];

qg_max = [ 3.0;3.0;3.0];
qg_min = [-3;-3;-3];
ppq0 = [ 0.9
 1.0
 1.25];
qpq0 = [ 0.3
 0.35
 0.5];
M_ineq_plus = [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 17.36111111111111 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 16.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.0 0.0 0.0 0.0 17.064846416382252 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0];
M_ineq_minus = [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -17.36111111111111 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -16.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -17.064846416382252];


M_line_plus = [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 17.36111111111111 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 10.51068205186793 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.9421912487147264 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 5.588244962361526 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.2820091384241148 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 17.064846416382252 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 9.784270426363172 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.1550874808900968 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 13.697978596908442 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.6171224732461358 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 16.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 5.975134533308592 0.0 1.1876043792911486 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 11.604095563139932 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.36518771331058 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.9421912487147264 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.2820091384241148 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.1550874808900968 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.6171224732461358 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.1876043792911486 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.36518771331058 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 17.36111111111111 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 10.431682051867929 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 5.409244962361526 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 17.064846416382252; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 9.679770426363172 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 13.623478596908441 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 16.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 5.822134533308592 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 11.516095563139933 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 17.36111111111111 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.9421912487147264 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 10.431682051867929 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.2820091384241148 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 5.409244962361526 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 17.064846416382252 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.1550874808900968 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 9.679770426363172 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.6171224732461358 0.0 0.0 0.0 13.623478596908441 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 16.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.1876043792911486 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 5.822134533308592 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 1.36518771331058 0.0 11.516095563139933 0.0 0.0 0.0 0.0 0.0 0.0 0.0];
M_line_minus = [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -1.9421912487147264 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -1.2820091384241148 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -1.1550874808900968 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -1.6171224732461358 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -1.1876043792911486 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -1.36518771331058 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -17.36111111111111 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -1.9421912487147264 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -10.51068205186793 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -1.2820091384241148 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -5.588244962361526 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -17.064846416382252 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -1.1550874808900968 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -9.784270426363172 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -1.6171224732461358 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -13.697978596908442 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -16.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -1.1876043792911486 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -5.975134533308592 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -1.36518771331058 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -11.604095563139932 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -17.36111111111111 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -10.51068205186793 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -1.9421912487147264 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -5.588244962361526 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -1.2820091384241148 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -17.064846416382252 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -9.784270426363172 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -1.1550874808900968 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -13.697978596908442 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -1.6171224732461358 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -16.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -5.975134533308592 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -1.1876043792911486 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -11.604095563139932 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -1.36518771331058 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -17.36111111111111 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -10.51068205186793 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -5.588244962361526 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -17.064846416382252 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -9.784270426363172 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -13.697978596908442 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -16.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -5.975134533308592 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0; 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 -11.604095563139932 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0];


s_line_max = [ 2.5
 2.5
 1.5
 3.0
 1.5
 2.5
 2.5
 2.5
 2.5];

idx_pq = [ 1
 2
 4
 6
 7
 8];
xi = [0.08889106908831582; 0.07101838956533643; 0.07232856324034986; 0.0006239619373674453; 0.04234907811668922; 0.03399736059908912; 0.0012103185951721773; 0.07659898590263627; 0.08905833183230735; 0.019096623211807048; 0.022415884201508942; 0.04172803216302733; 0.014847982741299713; 0.03405491968793854; 0.058002835850067914; 1.8412067868864026; 0.08889106908831582; 0.07101838956533643; 0.07232856324034986; 0.0006239619373674453; 0.04234907811668922; 0.03399736059908912; 0.0012103185951721773; 0.07659898590263627; 0.08905833183230735; 0.019096623211807048; 0.022415884201508942; 0.04172803216302733; 0.014847982741299713; 0.03405491968793854; 0.058002835850067914; 1.8412067868864026;];
K = [-0.046292 -0.047968 0.0 -0.04845 -0.046262 -0.04636 -0.04674 -0.048501 -0.046342 -0.000422 -0.001615 0.0 -0.001277 0.0 -0.000391 -0.000489 -0.001486 0.0 -0.028046 -0.217663 -0.130871 -0.00668 -0.116152 -0.162918 -0.006748 -0.123976 -0.16769 -0.832785 -0.005723 0.010544 -0.000309 -0.0036 0.006028 0.00047 -0.011933 0.006352 0.144785 0.222151 0.0 0.176439 0.0 0.125571 0.140966 0.149579 0.0; -0.027903 -0.000145 0.0 -0.068079 -0.027913 -0.047503 -0.03635 -0.010194 -0.047531 0.000147 -0.00336 0.0 0.006086 0.0 0.000617 0.000274 -0.002463 0.0 -0.058332 -0.103845 -0.110716 0.010531 -0.088143 -0.098141 0.002356 -0.059083 -0.081686 -0.002509 -0.732384 0.121996 0.000487 0.10952 0.115911 -0.000164 0.108912 0.117844 0.073041 0.132552 0.0 0.123085 0.0 0.095927 0.094396 0.068731 0.0; -0.052779 -6.7e-5 0.0 0.019151 -0.052953 -0.089132 -0.068181 -0.01863 -0.089462 0.002491 -0.001565 0.0 -0.006287 0.0 0.007131 0.004399 -0.00052 0.0 -0.027167 -0.045468 -0.085005 0.121681 -0.0689 -0.101224 0.039857 -0.073026 -0.049713 -0.001169 0.211166 -0.622312 0.005625 0.208144 0.214062 -0.002779 0.207621 0.216832 0.059733 0.061734 0.0 0.037851 0.0 -0.012051 0.086495 0.056568 0.0; 1.1e-5 -1.4e-5 0.0 -0.000129 4.2e-5 -0.000106 -0.000104 -5.3e-5 0.049047 -0.000437 -0.000335 0.0 -0.000811 0.0 -0.001613 -0.000953 -0.000392 0.0 -0.005819 -0.01233 -0.013849 -0.027524 -0.025346 -0.019184 -0.006987 -0.005003 -0.008534 -0.00025 -0.00028 0.001158 -0.838788 -0.00075 0.000751 0.000487 -0.000436 0.000368 0.015448 0.013222 0.0 0.013271 0.0 0.052118 0.022493 0.006937 0.0; -0.030691 -1.2e-5 0.0 0.011433 -0.030784 0.032534 -0.039688 -0.010764 0.032725 0.001325 -0.000277 0.0 -0.001754 0.0 -0.004115 0.002066 9.3e-5 0.0 -0.004816 0.000832 0.023572 -0.070216 -0.028312 -0.067367 0.0212 -0.04076 -0.016852 -0.000207 0.123157 0.120948 -0.003246 -0.713781 0.124433 -0.001478 0.120533 0.125271 0.039114 0.010944 0.0 -0.00908 0.0 0.053013 0.061888 0.025868 0.0; -0.021866 3.0e-5 0.0 0.008357 -0.022142 0.023305 0.032338 -0.007444 0.023334 0.003958 0.000692 0.0 0.000181 0.0 -0.000644 -0.000804 0.001785 0.0 0.012021 0.025468 0.038002 -0.010993 0.050106 0.060148 0.063334 -0.000494 0.018621 0.000517 0.088522 0.084587 -0.000508 0.088567 -0.75018 -0.004415 0.088753 0.088218 -0.078981 -0.027317 0.0 -0.029811 0.0 -0.036082 -0.07092 -0.011937 0.0; 7.5e-5 2.3e-5 0.0 5.7e-5 -0.052005 -4.9e-5 0.000155 0.000191 -7.9e-5 0.002537 0.000545 0.0 0.000606 0.0 0.000658 0.001803 0.001305 0.0 0.009462 0.012259 0.007079 0.011236 0.024206 0.059822 0.040593 0.023271 0.021757 0.000407 0.000235 -0.000658 0.000519 0.000671 -0.002285 -0.833279 0.002158 -0.000909 -0.090137 -0.0215 0.0 -0.009791 0.0 -0.021052 -0.042446 -0.02311 0.0; 0.088138 3.3e-5 0.0 0.019105 0.088708 0.053644 0.073933 -0.017394 0.053781 -0.008179 0.000762 0.0 -0.000688 0.0 -0.00298 -0.006117 0.002285 0.0 0.013235 0.037953 0.072768 -0.050853 0.058353 0.066256 -0.130868 0.048794 0.011655 0.000569 0.203278 0.195949 -0.002351 0.20214 0.197911 0.009124 -0.642994 0.204302 0.042717 -0.030076 0.0 -0.050703 0.0 -0.034916 -0.062408 0.004794 0.0; 0.045102 0.000161 0.0 0.010033 0.045084 0.027152 0.037948 0.064427 0.027153 0.000258 0.003747 0.0 0.002462 0.0 -9.0e-6 0.000182 -0.001179 0.0 0.065058 0.085059 0.061379 -0.000149 0.076896 0.140328 0.00412 0.124569 0.117976 0.002798 0.106261 0.098832 -7.0e-6 0.10541 0.097863 -0.000287 0.117175 -0.752467 -0.135625 -0.147838 0.0 -0.071342 0.0 -0.065892 -0.109452 -0.144022 0.0; 0.001182 0.00037 0.0 0.000902 -0.001609 -0.000767 0.002447 0.003016 -0.001248 0.04003 0.008599 0.0 0.009569 0.0 0.010388 0.028448 0.020586 0.0 0.149287 0.193429 0.1117 0.177277 0.381928 0.943881 0.640479 0.367175 0.343289 0.006421 0.003706 -0.010378 0.008195 0.010587 -0.036052 -0.044652 0.034051 -0.014343 -1.422202 -0.339238 0.0 -0.154492 0.0 -0.332158 -0.66972 -0.364627 0.0; -0.005419 0.001732 0.0 0.00193 -0.006033 -0.005742 -0.004972 0.003195 -0.006118 0.008815 0.040259 0.0 0.030094 0.0 0.008136 0.008761 0.031187 0.0 0.698941 0.74657 0.208753 0.138842 0.152953 0.223955 0.141039 0.236379 0.835797 0.030063 0.021825 -0.014719 0.006418 0.006811 -0.006212 -0.009833 0.024896 -0.02936 -0.297254 -1.588264 0.0 -0.48294 0.0 -0.247616 -0.190381 -0.548891 0.0; -0.005804 0.001296 0.0 0.015314 -0.00649 -0.006413 -0.005096 0.001906 -0.007324 0.009839 0.030138 0.0 0.084413 0.0 0.019695 0.014324 0.024518 0.0 0.523234 1.236274 0.59319 0.336085 0.319557 0.313369 0.157431 0.200658 0.638604 0.022506 0.041927 -0.038449 0.015536 0.019091 -0.002446 -0.010976 0.028636 -0.014747 -0.332486 -1.18899 0.0 -1.386557 0.0 -0.617628 -0.319678 -0.429957 0.0; -0.000268 0.000343 0.0 0.003071 -0.000993 0.002517 0.002486 0.001258 0.000743 0.010392 0.007975 0.0 0.01931 0.0 0.038381 0.022673 0.009336 0.0 0.138461 0.293419 0.329555 0.654961 0.603147 0.456514 0.166274 0.119054 0.203069 0.005956 0.006661 -0.027545 0.030276 0.017837 -0.017864 -0.011592 0.010376 -0.008765 -0.367603 -0.314637 0.0 -0.315791 0.0 -1.240224 -0.53525 -0.165083 0.0; 0.000517 0.000368 0.0 0.001882 -0.001465 0.000698 0.008551 0.002318 -0.000348 0.028421 0.008561 0.0 0.013986 0.0 0.022629 0.06612 0.016322 0.0 0.14862 0.241354 0.207923 0.386158 0.879024 1.309688 0.454744 0.270717 0.29241 0.006393 0.005375 -0.017697 0.01785 0.026596 -0.049083 -0.031703 0.02513 -0.012028 -1.008866 -0.337723 0.0 -0.227626 0.0 -0.729307 -1.564511 -0.288917 0.0; -0.008115 0.001325 0.0 0.000614 -0.009565 -0.007156 -0.006583 0.012719 -0.007594 0.0208 0.030814 0.0 0.024222 0.0 0.009482 0.016522 0.083207 0.0 0.53496 0.582228 0.179957 0.161803 0.238557 0.487467 0.3328 0.626923 1.342279 0.02301 0.005325 -0.024522 0.007479 -0.002524 -0.02791 -0.023202 0.050371 -0.060685 -0.714509 -1.215636 0.0 -0.385676 0.0 -0.287433 -0.366766 -1.475129 0.0; -0.970896 -1.00003 -1.0 -1.009928 -0.970786 -0.972592 -0.979882 -1.00994 -0.972523 -0.001571 -0.000687 0.0 -0.001959 0.0 -0.001495 -0.003017 -0.005433 0.0 -0.011927 -3.931528 -2.560908 -0.025511 -2.299423 -3.21749 -0.025135 -2.394296 -2.814999 -0.000513 -0.10157 0.208048 -0.001179 -0.069565 0.120751 0.001752 -0.228706 0.108517 2.77878 3.334482 0.0 3.287236 0.0 2.41837 2.786741 2.672359 0.0; 0.046292 0.047968 0.0 0.04845 0.046262 0.04636 0.04674 0.048501 0.046342 0.000422 0.001615 0.0 0.001277 0.0 0.000391 0.000489 0.001486 0.0 0.028046 0.217663 0.130871 0.00668 0.116152 0.162918 0.006748 0.123976 0.16769 0.832785 0.005723 -0.010544 0.000309 0.0036 -0.006028 -0.00047 0.011933 -0.006352 -0.144785 -0.222151 0.0 -0.176439 0.0 -0.125571 -0.140966 -0.149579 0.0; 0.027903 0.000145 0.0 0.068079 0.027913 0.047503 0.03635 0.010194 0.047531 -0.000147 0.00336 0.0 -0.006086 0.0 -0.000617 -0.000274 0.002463 0.0 0.058332 0.103845 0.110716 -0.010531 0.088143 0.098141 -0.002356 0.059083 0.081686 0.002509 0.732384 -0.121996 -0.000487 -0.10952 -0.115911 0.000164 -0.108912 -0.117844 -0.073041 -0.132552 0.0 -0.123085 0.0 -0.095927 -0.094396 -0.068731 0.0; 0.052779 6.7e-5 0.0 -0.019151 0.052953 0.089132 0.068181 0.01863 0.089462 -0.002491 0.001565 0.0 0.006287 0.0 -0.007131 -0.004399 0.00052 0.0 0.027167 0.045468 0.085005 -0.121681 0.0689 0.101224 -0.039857 0.073026 0.049713 0.001169 -0.211166 0.622312 -0.005625 -0.208144 -0.214062 0.002779 -0.207621 -0.216832 -0.059733 -0.061734 0.0 -0.037851 0.0 0.012051 -0.086495 -0.056568 0.0; -1.1e-5 1.4e-5 0.0 0.000129 -4.2e-5 0.000106 0.000104 5.3e-5 -0.049047 0.000437 0.000335 0.0 0.000811 0.0 0.001613 0.000953 0.000392 0.0 0.005819 0.01233 0.013849 0.027524 0.025346 0.019184 0.006987 0.005003 0.008534 0.00025 0.00028 -0.001158 0.838788 0.00075 -0.000751 -0.000487 0.000436 -0.000368 -0.015448 -0.013222 0.0 -0.013271 0.0 -0.052118 -0.022493 -0.006937 0.0; 0.030691 1.2e-5 0.0 -0.011433 0.030784 -0.032534 0.039688 0.010764 -0.032725 -0.001325 0.000277 0.0 0.001754 0.0 0.004115 -0.002066 -9.3e-5 0.0 0.004816 -0.000832 -0.023572 0.070216 0.028312 0.067367 -0.0212 0.04076 0.016852 0.000207 -0.123157 -0.120948 0.003246 0.713781 -0.124433 0.001478 -0.120533 -0.125271 -0.039114 -0.010944 0.0 0.00908 0.0 -0.053013 -0.061888 -0.025868 0.0; 0.021866 -3.0e-5 0.0 -0.008357 0.022142 -0.023305 -0.032338 0.007444 -0.023334 -0.003958 -0.000692 0.0 -0.000181 0.0 0.000644 0.000804 -0.001785 0.0 -0.012021 -0.025468 -0.038002 0.010993 -0.050106 -0.060148 -0.063334 0.000494 -0.018621 -0.000517 -0.088522 -0.084587 0.000508 -0.088567 0.75018 0.004415 -0.088753 -0.088218 0.078981 0.027317 0.0 0.029811 0.0 0.036082 0.07092 0.011937 0.0; -7.5e-5 -2.3e-5 0.0 -5.7e-5 0.052005 4.9e-5 -0.000155 -0.000191 7.9e-5 -0.002537 -0.000545 0.0 -0.000606 0.0 -0.000658 -0.001803 -0.001305 0.0 -0.009462 -0.012259 -0.007079 -0.011236 -0.024206 -0.059822 -0.040593 -0.023271 -0.021757 -0.000407 -0.000235 0.000658 -0.000519 -0.000671 0.002285 0.833279 -0.002158 0.000909 0.090137 0.0215 0.0 0.009791 0.0 0.021052 0.042446 0.02311 0.0; -0.088138 -3.3e-5 0.0 -0.019105 -0.088708 -0.053644 -0.073933 0.017394 -0.053781 0.008179 -0.000762 0.0 0.000688 0.0 0.00298 0.006117 -0.002285 0.0 -0.013235 -0.037953 -0.072768 0.050853 -0.058353 -0.066256 0.130868 -0.048794 -0.011655 -0.000569 -0.203278 -0.195949 0.002351 -0.20214 -0.197911 -0.009124 0.642994 -0.204302 -0.042717 0.030076 0.0 0.050703 0.0 0.034916 0.062408 -0.004794 0.0; -0.045102 -0.000161 0.0 -0.010033 -0.045084 -0.027152 -0.037948 -0.064427 -0.027153 -0.000258 -0.003747 0.0 -0.002462 0.0 9.0e-6 -0.000182 0.001179 0.0 -0.065058 -0.085059 -0.061379 0.000149 -0.076896 -0.140328 -0.00412 -0.124569 -0.117976 -0.002798 -0.106261 -0.098832 7.0e-6 -0.10541 -0.097863 0.000287 -0.117175 0.752467 0.135625 0.147838 0.0 0.071342 0.0 0.065892 0.109452 0.144022 0.0; -0.001182 -0.00037 0.0 -0.000902 0.001609 0.000767 -0.002447 -0.003016 0.001248 -0.04003 -0.008599 0.0 -0.009569 0.0 -0.010388 -0.028448 -0.020586 0.0 -0.149287 -0.193429 -0.1117 -0.177277 -0.381928 -0.943881 -0.640479 -0.367175 -0.343289 -0.006421 -0.003706 0.010378 -0.008195 -0.010587 0.036052 0.044652 -0.034051 0.014343 1.422202 0.339238 0.0 0.154492 0.0 0.332158 0.66972 0.364627 0.0; 0.005419 -0.001732 0.0 -0.00193 0.006033 0.005742 0.004972 -0.003195 0.006118 -0.008815 -0.040259 0.0 -0.030094 0.0 -0.008136 -0.008761 -0.031187 0.0 -0.698941 -0.74657 -0.208753 -0.138842 -0.152953 -0.223955 -0.141039 -0.236379 -0.835797 -0.030063 -0.021825 0.014719 -0.006418 -0.006811 0.006212 0.009833 -0.024896 0.02936 0.297254 1.588264 0.0 0.48294 0.0 0.247616 0.190381 0.548891 0.0; 0.005804 -0.001296 0.0 -0.015314 0.00649 0.006413 0.005096 -0.001906 0.007324 -0.009839 -0.030138 0.0 -0.084413 0.0 -0.019695 -0.014324 -0.024518 0.0 -0.523234 -1.236274 -0.59319 -0.336085 -0.319557 -0.313369 -0.157431 -0.200658 -0.638604 -0.022506 -0.041927 0.038449 -0.015536 -0.019091 0.002446 0.010976 -0.028636 0.014747 0.332486 1.18899 0.0 1.386557 0.0 0.617628 0.319678 0.429957 0.0; 0.000268 -0.000343 0.0 -0.003071 0.000993 -0.002517 -0.002486 -0.001258 -0.000743 -0.010392 -0.007975 0.0 -0.01931 0.0 -0.038381 -0.022673 -0.009336 0.0 -0.138461 -0.293419 -0.329555 -0.654961 -0.603147 -0.456514 -0.166274 -0.119054 -0.203069 -0.005956 -0.006661 0.027545 -0.030276 -0.017837 0.017864 0.011592 -0.010376 0.008765 0.367603 0.314637 0.0 0.315791 0.0 1.240224 0.53525 0.165083 0.0; -0.000517 -0.000368 0.0 -0.001882 0.001465 -0.000698 -0.008551 -0.002318 0.000348 -0.028421 -0.008561 0.0 -0.013986 0.0 -0.022629 -0.06612 -0.016322 0.0 -0.14862 -0.241354 -0.207923 -0.386158 -0.879024 -1.309688 -0.454744 -0.270717 -0.29241 -0.006393 -0.005375 0.017697 -0.01785 -0.026596 0.049083 0.031703 -0.02513 0.012028 1.008866 0.337723 0.0 0.227626 0.0 0.729307 1.564511 0.288917 0.0; 0.008115 -0.001325 0.0 -0.000614 0.009565 0.007156 0.006583 -0.012719 0.007594 -0.0208 -0.030814 0.0 -0.024222 0.0 -0.009482 -0.016522 -0.083207 0.0 -0.53496 -0.582228 -0.179957 -0.161803 -0.238557 -0.487467 -0.3328 -0.626923 -1.342279 -0.02301 -0.005325 0.024522 -0.007479 0.002524 0.02791 0.023202 -0.050371 0.060685 0.714509 1.215636 0.0 0.385676 0.0 0.287433 0.366766 1.475129 0.0; 0.970896 1.00003 1.0 1.009928 0.970786 0.972592 0.979882 1.00994 0.972523 0.001571 0.000687 0.0 0.001959 0.0 0.001495 0.003017 0.005433 0.0 0.011927 3.931528 2.560908 0.025511 2.299423 3.21749 0.025135 2.394296 2.814999 0.000513 0.10157 -0.208048 0.001179 0.069565 -0.120751 -0.001752 0.228706 -0.108517 -2.77878 -3.334482 0.0 -3.287236 0.0 -2.41837 -2.786741 -2.672359 0.0];
tol1 = 0;
K_plus = max(K,zeros(size(K))).*(K>tol1);
K_minus = min(K,zeros(size(K))).*(K<-tol1);


gencost = [	0.11	5	150;
	        0.085	1.2	600;
	        0.1225	1	335;];

gamma0 = 0.2;

pg0 = [ 0.8979870772560286
 1.3432060071139884
 0.9418738038603868];
pl0 = [ 0.9
 1.0
 1.25];
ql0 =[ 0.3
 0.35
 0.5];

x = vertcat(v_u,v_l,Delta_v_u,Delta_v_l,Phi_u,Phi_l,Delta_Phi_u,Delta_Phi_l,delta_u,delta_l,Ddelta_u,Ddelta_l,...%8*9+4 = 76:1-76
    g_u_pinj,g_l_pinj,g_u_qinj,g_l_qinj,g_u_vvsin,g_l_vvsin,g_u_vvcos,g_l_vvcos,g_u_vv,g_l_vv,...%90: 77-166
    Psi_u_vvcos,Psi_l_vvcos,Psi_u_vvsin,Psi_l_vvsin,Psi_u_vv,Psi_l_vv,...%54: 167-220
    Delta_vv_u_uu,Delta_vv_u_ll,Delta_vv_u_ul,Delta_vv_u_lu,Delta_vv_l_uu,Delta_vv_l_ll,Delta_vv_l_ul,Delta_vv_l_lu,...%72 221-292
    Delta_cos_u_u,Delta_cos_u_l,Delta_cos_l_u,Delta_cos_l_l,Delta_sin_u_u,Delta_sin_u_l,Delta_sin_l_u,Delta_sin_l_l,...%72 293-364
    p_line_fr_u,q_line_fr_u,p_line_to_u,q_line_to_u,pg_opt,pl_opt,ql_opt,pg_opt_u,alpha_opt,Dalpha_opt,...%60 365-424
    cost_opt,gamma_opt,slack_pg,slack_qg,slack_line,margin_opt);

x0 = vertcat(v0,v0,zeros(2*Nbus,1),Phi0,Phi0,zeros(2*Nbranch,1),delta0,delta0,zeros(2+8*Nbus+28*Nbranch,1),...
    pg0,pl0,ql0,pg0,alpha0,zeros(Ngen,1),5926.69,zeros(5,1));

lbx = vertcat(vmin,vmin,vmin-v0,vmin-v0,Phi_min,Phi_min,Phi_min-Phi0,Phi_min-Phi0,...
    -inf(4+8*Nbus+28*Nbranch,1),pg_min,-inf(2*3+3*Ngen+6,1));
ubx = vertcat(vmax,vmax,vmax-v0,vmax-v0,Phi_max,Phi_max,Phi_max-Phi0,Phi_max-Phi0,...
    inf(4+8*Nbus+28*Nbranch,1),pg_max,inf(2*3+3*Ngen+6,1));

% Equality constraints
g_v1 = v_u(id_gen)-v_l(id_gen);
g_v2 = v_u-Delta_v_u;
g_v3 = v_l-Delta_v_l;
g_Phi1 = Phi_u-Delta_Phi_u;
g_Phi2 = Phi_l-Delta_Phi_l;
g_delta1 = delta_u-Ddelta_u;
g_delta2 = delta_l-Ddelta_l;
g_alpha = alpha_opt-Dalpha_opt;
g_alpha2 = alpha_opt; % ==alpha0
% inequality constraints 
% >=
g_vv1 = Delta_vv_u_uu-Delta_v_u(idx_fr).*v0(idx_to)-v0(idx_fr).*Delta_v_u(idx_to)-1/4*(Delta_v_u(idx_fr)+Delta_v_u(idx_to)).^2;
g_vv2 = Delta_vv_u_ll-Delta_v_l(idx_fr).*v0(idx_to)-v0(idx_fr).*Delta_v_l(idx_to)-1/4*(Delta_v_l(idx_fr)+Delta_v_l(idx_to)).^2;
g_vv3 = Delta_vv_u_ul-Delta_v_u(idx_fr).*v0(idx_to)-v0(idx_fr).*Delta_v_l(idx_to)-1/4*(Delta_v_u(idx_fr)+Delta_v_l(idx_to)).^2;
g_vv4 = Delta_vv_u_lu-Delta_v_l(idx_fr).*v0(idx_to)-v0(idx_fr).*Delta_v_u(idx_to)-1/4*(Delta_v_l(idx_fr)+Delta_v_u(idx_to)).^2;
% <= 
g_vv5 = Delta_vv_l_uu-Delta_v_u(idx_fr).*v0(idx_to)-v0(idx_fr).*Delta_v_u(idx_to)+1/4*(Delta_v_u(idx_fr)-Delta_v_u(idx_to)).^2;
g_vv6 = Delta_vv_l_ll-Delta_v_l(idx_fr).*v0(idx_to)-v0(idx_fr).*Delta_v_l(idx_to)+1/4*(Delta_v_l(idx_fr)-Delta_v_l(idx_to)).^2;
g_vv7 = Delta_vv_l_ul-Delta_v_u(idx_fr).*v0(idx_to)-v0(idx_fr).*Delta_v_l(idx_to)+1/4*(Delta_v_u(idx_fr)-Delta_v_l(idx_to)).^2;
g_vv8 = Delta_vv_l_lu-Delta_v_l(idx_fr).*v0(idx_to)-v0(idx_fr).*Delta_v_u(idx_to)+1/4*(Delta_v_l(idx_fr)-Delta_v_u(idx_to)).^2;
% >= / <=
g_cos1 = Delta_cos_u_u+sin(Phi0).*Delta_Phi_u-1/2*(Delta_Phi_u).^2;
g_cos2 = Delta_cos_u_l+sin(Phi0).*Delta_Phi_l-1/2*(Delta_Phi_l).^2;
g_cos3 = Delta_cos_l_u+sin(Phi0).*Delta_Phi_u+1/2*(Delta_Phi_u).^2;
g_cos4 = Delta_cos_l_l+sin(Phi0).*Delta_Phi_l+1/2*(Delta_Phi_l).^2;
% >= / <=
g_sin1 = Delta_sin_u_u-cos(Phi0).*Delta_Phi_u-1/2*(Delta_Phi_u).^2;
g_sin2 = Delta_sin_u_l-cos(Phi0).*Delta_Phi_l-1/2*(Delta_Phi_l).^2;
g_sin3 = Delta_sin_l_u-cos(Phi0).*Delta_Phi_u+1/2*(Delta_Phi_u).^2;
g_sin4 = Delta_sin_l_l-cos(Phi0).*Delta_Phi_l+1/2*(Delta_Phi_l).^2;
% >= Ïˆ_vvcos0
g_gcos11 = g_u_vvcos - cos(Phi0).*Delta_vv_u_uu - v0(idx_fr).*v0(idx_to).*Delta_cos_u_u - 1/4*(Delta_vv_u_uu+Delta_cos_u_u).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*cos(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*cos(Phi0) - v0(idx_fr).*v0(idx_to).*sin(Phi0).*Phi_u;
g_gcos12 = g_u_vvcos - cos(Phi0).*Delta_vv_u_uu - v0(idx_fr).*v0(idx_to).*Delta_cos_u_l - 1/4*(Delta_vv_u_uu+Delta_cos_u_l).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*cos(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*cos(Phi0) - v0(idx_fr).*v0(idx_to).*sin(Phi0).*Phi_l;
g_gcos13 = g_u_vvcos - cos(Phi0).*Delta_vv_u_ul - v0(idx_fr).*v0(idx_to).*Delta_cos_u_u - 1/4*(Delta_vv_u_ul+Delta_cos_u_u).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*cos(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*cos(Phi0) - v0(idx_fr).*v0(idx_to).*sin(Phi0).*Phi_u;
g_gcos14 = g_u_vvcos - cos(Phi0).*Delta_vv_u_ul - v0(idx_fr).*v0(idx_to).*Delta_cos_u_l - 1/4*(Delta_vv_u_ul+Delta_cos_u_l).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*cos(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*cos(Phi0) - v0(idx_fr).*v0(idx_to).*sin(Phi0).*Phi_l;
g_gcos15 = g_u_vvcos - cos(Phi0).*Delta_vv_u_lu - v0(idx_fr).*v0(idx_to).*Delta_cos_u_u - 1/4*(Delta_vv_u_lu+Delta_cos_u_u).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*cos(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*cos(Phi0) - v0(idx_fr).*v0(idx_to).*sin(Phi0).*Phi_u;
g_gcos16 = g_u_vvcos - cos(Phi0).*Delta_vv_u_lu - v0(idx_fr).*v0(idx_to).*Delta_cos_u_l - 1/4*(Delta_vv_u_lu+Delta_cos_u_l).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*cos(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*cos(Phi0) - v0(idx_fr).*v0(idx_to).*sin(Phi0).*Phi_l;
g_gcos17 = g_u_vvcos - cos(Phi0).*Delta_vv_u_ll - v0(idx_fr).*v0(idx_to).*Delta_cos_u_u - 1/4*(Delta_vv_u_ll+Delta_cos_u_u).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*cos(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*cos(Phi0) - v0(idx_fr).*v0(idx_to).*sin(Phi0).*Phi_u;
g_gcos18 = g_u_vvcos - cos(Phi0).*Delta_vv_u_ll - v0(idx_fr).*v0(idx_to).*Delta_cos_u_l - 1/4*(Delta_vv_u_ll+Delta_cos_u_l).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*cos(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*cos(Phi0) - v0(idx_fr).*v0(idx_to).*sin(Phi0).*Phi_l;
% <= Ïˆ_vvcos0
g_gcos21 = g_l_vvcos - cos(Phi0).*Delta_vv_l_uu - v0(idx_fr).*v0(idx_to).*Delta_cos_l_u + 1/4*(Delta_vv_l_uu-Delta_cos_l_u).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*cos(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*cos(Phi0) - v0(idx_fr).*v0(idx_to).*sin(Phi0).*Phi_u;
g_gcos22 = g_l_vvcos - cos(Phi0).*Delta_vv_l_uu - v0(idx_fr).*v0(idx_to).*Delta_cos_l_l + 1/4*(Delta_vv_l_uu-Delta_cos_l_l).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*cos(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*cos(Phi0) - v0(idx_fr).*v0(idx_to).*sin(Phi0).*Phi_l;
g_gcos23 = g_l_vvcos - cos(Phi0).*Delta_vv_l_ul - v0(idx_fr).*v0(idx_to).*Delta_cos_l_u + 1/4*(Delta_vv_l_ul-Delta_cos_l_u).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*cos(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*cos(Phi0) - v0(idx_fr).*v0(idx_to).*sin(Phi0).*Phi_u;
g_gcos24 = g_l_vvcos - cos(Phi0).*Delta_vv_l_ul - v0(idx_fr).*v0(idx_to).*Delta_cos_l_l + 1/4*(Delta_vv_l_ul-Delta_cos_l_l).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*cos(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*cos(Phi0) - v0(idx_fr).*v0(idx_to).*sin(Phi0).*Phi_l;
g_gcos25 = g_l_vvcos - cos(Phi0).*Delta_vv_l_lu - v0(idx_fr).*v0(idx_to).*Delta_cos_l_u + 1/4*(Delta_vv_l_lu-Delta_cos_l_u).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*cos(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*cos(Phi0) - v0(idx_fr).*v0(idx_to).*sin(Phi0).*Phi_u;
g_gcos26 = g_l_vvcos - cos(Phi0).*Delta_vv_l_lu - v0(idx_fr).*v0(idx_to).*Delta_cos_l_l + 1/4*(Delta_vv_l_lu-Delta_cos_l_l).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*cos(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*cos(Phi0) - v0(idx_fr).*v0(idx_to).*sin(Phi0).*Phi_l;
g_gcos27 = g_l_vvcos - cos(Phi0).*Delta_vv_l_ll - v0(idx_fr).*v0(idx_to).*Delta_cos_l_u + 1/4*(Delta_vv_l_ll-Delta_cos_l_u).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*cos(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*cos(Phi0) - v0(idx_fr).*v0(idx_to).*sin(Phi0).*Phi_u;
g_gcos28 = g_l_vvcos - cos(Phi0).*Delta_vv_l_ll - v0(idx_fr).*v0(idx_to).*Delta_cos_l_l + 1/4*(Delta_vv_l_ll-Delta_cos_l_l).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*cos(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*cos(Phi0) - v0(idx_fr).*v0(idx_to).*sin(Phi0).*Phi_l;
% >= Psi_vvsin0
g_gsin11 = g_u_vvsin - sin(Phi0).*Delta_vv_u_uu - v0(idx_fr).*v0(idx_to).*Delta_sin_u_u - 1/4*(Delta_vv_u_uu+Delta_sin_u_u).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_u;
g_gsin12 = g_u_vvsin - sin(Phi0).*Delta_vv_u_uu - v0(idx_fr).*v0(idx_to).*Delta_sin_u_l - 1/4*(Delta_vv_u_uu+Delta_sin_u_l).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_l;
g_gsin13 = g_u_vvsin - sin(Phi0).*Delta_vv_u_ul - v0(idx_fr).*v0(idx_to).*Delta_sin_u_u - 1/4*(Delta_vv_u_ul+Delta_sin_u_u).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_u;
g_gsin14 = g_u_vvsin - sin(Phi0).*Delta_vv_u_ul - v0(idx_fr).*v0(idx_to).*Delta_sin_u_l - 1/4*(Delta_vv_u_ul+Delta_sin_u_l).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_l;
g_gsin15 = g_u_vvsin - sin(Phi0).*Delta_vv_u_lu - v0(idx_fr).*v0(idx_to).*Delta_sin_u_u - 1/4*(Delta_vv_u_lu+Delta_sin_u_u).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_u;
g_gsin16 = g_u_vvsin - sin(Phi0).*Delta_vv_u_lu - v0(idx_fr).*v0(idx_to).*Delta_sin_u_l - 1/4*(Delta_vv_u_lu+Delta_sin_u_l).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_l;
g_gsin17 = g_u_vvsin - sin(Phi0).*Delta_vv_u_ll - v0(idx_fr).*v0(idx_to).*Delta_sin_u_u - 1/4*(Delta_vv_u_ll+Delta_sin_u_u).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_u;
g_gsin18 = g_u_vvsin - sin(Phi0).*Delta_vv_u_ll - v0(idx_fr).*v0(idx_to).*Delta_sin_u_l - 1/4*(Delta_vv_u_ll+Delta_sin_u_l).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_l;
% >= Psi_vvsin0
g_gsin21 = g_u_vvsin - sin(Phi0).*Delta_vv_l_uu - v0(idx_fr).*v0(idx_to).*Delta_sin_u_u - 1/4*(Delta_vv_l_uu+Delta_sin_u_u).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_u;
g_gsin22 = g_u_vvsin - sin(Phi0).*Delta_vv_l_uu - v0(idx_fr).*v0(idx_to).*Delta_sin_u_l - 1/4*(Delta_vv_l_uu+Delta_sin_u_l).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_l;
g_gsin23 = g_u_vvsin - sin(Phi0).*Delta_vv_l_ul - v0(idx_fr).*v0(idx_to).*Delta_sin_u_u - 1/4*(Delta_vv_l_ul+Delta_sin_u_u).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_u;
g_gsin24 = g_u_vvsin - sin(Phi0).*Delta_vv_l_ul - v0(idx_fr).*v0(idx_to).*Delta_sin_u_l - 1/4*(Delta_vv_l_ul+Delta_sin_u_l).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_l;
g_gsin25 = g_u_vvsin - sin(Phi0).*Delta_vv_l_lu - v0(idx_fr).*v0(idx_to).*Delta_sin_u_u - 1/4*(Delta_vv_l_lu+Delta_sin_u_u).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_u;
g_gsin26 = g_u_vvsin - sin(Phi0).*Delta_vv_l_lu - v0(idx_fr).*v0(idx_to).*Delta_sin_u_l - 1/4*(Delta_vv_l_lu+Delta_sin_u_l).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_l;
g_gsin27 = g_u_vvsin - sin(Phi0).*Delta_vv_l_ll - v0(idx_fr).*v0(idx_to).*Delta_sin_u_u - 1/4*(Delta_vv_l_ll+Delta_sin_u_u).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_u;
g_gsin28 = g_u_vvsin - sin(Phi0).*Delta_vv_l_ll - v0(idx_fr).*v0(idx_to).*Delta_sin_u_l - 1/4*(Delta_vv_l_ll+Delta_sin_u_l).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_l;
% <= Psi_vvsin0
g_gsin31 = g_l_vvsin - sin(Phi0).*Delta_vv_l_uu - v0(idx_fr).*v0(idx_to).*Delta_sin_l_u + 1/4*(Delta_vv_l_uu-Delta_sin_l_u).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_u;
g_gsin32 = g_l_vvsin - sin(Phi0).*Delta_vv_l_uu - v0(idx_fr).*v0(idx_to).*Delta_sin_l_l + 1/4*(Delta_vv_l_uu-Delta_sin_l_l).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_l;
g_gsin33 = g_l_vvsin - sin(Phi0).*Delta_vv_l_ul - v0(idx_fr).*v0(idx_to).*Delta_sin_l_u + 1/4*(Delta_vv_l_ul-Delta_sin_l_u).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_u;
g_gsin34 = g_l_vvsin - sin(Phi0).*Delta_vv_l_ul - v0(idx_fr).*v0(idx_to).*Delta_sin_l_l + 1/4*(Delta_vv_l_ul-Delta_sin_l_l).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_l;
g_gsin35 = g_l_vvsin - sin(Phi0).*Delta_vv_l_lu - v0(idx_fr).*v0(idx_to).*Delta_sin_l_u + 1/4*(Delta_vv_l_lu-Delta_sin_l_u).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_u;
g_gsin36 = g_l_vvsin - sin(Phi0).*Delta_vv_l_lu - v0(idx_fr).*v0(idx_to).*Delta_sin_l_l + 1/4*(Delta_vv_l_lu-Delta_sin_l_l).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_l;
g_gsin37 = g_l_vvsin - sin(Phi0).*Delta_vv_l_ll - v0(idx_fr).*v0(idx_to).*Delta_sin_l_u + 1/4*(Delta_vv_l_ll-Delta_sin_l_u).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_u;
g_gsin38 = g_l_vvsin - sin(Phi0).*Delta_vv_l_ll - v0(idx_fr).*v0(idx_to).*Delta_sin_l_l + 1/4*(Delta_vv_l_ll-Delta_sin_l_l).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_l;
% <= Psi_vvsin0
g_gsin41 = g_l_vvsin - sin(Phi0).*Delta_vv_u_uu - v0(idx_fr).*v0(idx_to).*Delta_sin_l_u + 1/4*(Delta_vv_u_uu-Delta_sin_l_u).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_u;
g_gsin42 = g_l_vvsin - sin(Phi0).*Delta_vv_u_uu - v0(idx_fr).*v0(idx_to).*Delta_sin_l_l + 1/4*(Delta_vv_u_uu-Delta_sin_l_l).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_l;
g_gsin43 = g_l_vvsin - sin(Phi0).*Delta_vv_u_ul - v0(idx_fr).*v0(idx_to).*Delta_sin_l_u + 1/4*(Delta_vv_u_ul-Delta_sin_l_u).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_u;
g_gsin44 = g_l_vvsin - sin(Phi0).*Delta_vv_u_ul - v0(idx_fr).*v0(idx_to).*Delta_sin_l_l + 1/4*(Delta_vv_u_ul-Delta_sin_l_l).^2 + onoff_pq(idx_fr).*v_u(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_l;
g_gsin45 = g_l_vvsin - sin(Phi0).*Delta_vv_u_lu - v0(idx_fr).*v0(idx_to).*Delta_sin_l_u + 1/4*(Delta_vv_u_lu-Delta_sin_l_u).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_u;
g_gsin46 = g_l_vvsin - sin(Phi0).*Delta_vv_u_lu - v0(idx_fr).*v0(idx_to).*Delta_sin_l_l + 1/4*(Delta_vv_u_lu-Delta_sin_l_l).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_u(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_l;
g_gsin47 = g_l_vvsin - sin(Phi0).*Delta_vv_u_ll - v0(idx_fr).*v0(idx_to).*Delta_sin_l_u + 1/4*(Delta_vv_u_ll-Delta_sin_l_u).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_u;
g_gsin48 = g_l_vvsin - sin(Phi0).*Delta_vv_u_ll - v0(idx_fr).*v0(idx_to).*Delta_sin_l_l + 1/4*(Delta_vv_u_ll-Delta_sin_l_l).^2 + onoff_pq(idx_fr).*v_l(idx_fr).*v0(idx_to).*sin(Phi0) + v0(idx_fr).*onoff_pq(idx_to).*v_l(idx_to).*sin(Phi0) + v0(idx_fr).*v0(idx_to).*cos(Phi0).*Phi_l;
% >= 0
g_gvv1 = g_u_vv - v_u.^2 + 2*v0.*onoff_pq.*v_u;
g_gvv2 = g_u_vv - v_l.^2 + 2*v0.*onoff_pq.*v_l;
% <= Psi_vv0
g_gvv3 = g_l_vv - 2*v0.*(v_u-v0) + 2*v0.*onoff_pq.*v_u;
g_gvv4 = g_l_vv - 2*v0.*(v_l-v0) + 2*v0.*onoff_pq.*v_l;
% >= Psi_vvcos0 / <=
g_Psi1 = Psi_u_vvcos - cos(Phi0).*Delta_vv_u_uu - v0(idx_fr).*v0(idx_to).*Delta_cos_u_u - 1/4*(Delta_vv_u_uu+Delta_cos_u_u).^2;
g_Psi2 = Psi_u_vvcos - cos(Phi0).*Delta_vv_u_uu - v0(idx_fr).*v0(idx_to).*Delta_cos_u_l - 1/4*(Delta_vv_u_uu+Delta_cos_u_l).^2;
g_Psi3 = Psi_l_vvcos - cos(Phi0).*Delta_vv_l_ll - v0(idx_fr).*v0(idx_to).*Delta_cos_l_u + 1/4*(Delta_vv_l_ll-Delta_cos_l_u).^2;
g_Psi4 = Psi_l_vvcos - cos(Phi0).*Delta_vv_l_ll - v0(idx_fr).*v0(idx_to).*Delta_cos_l_l + 1/4*(Delta_vv_l_ll-Delta_cos_l_l).^2;
% >= Psi_vvsin0 / <=
g_Psi5 = Psi_u_vvsin - sin(Phi0).*Delta_vv_u_uu - v0(idx_fr).*v0(idx_to).*Delta_sin_u_u - 1/4*(Delta_vv_u_uu+Delta_sin_u_u).^2;
g_Psi6 = Psi_u_vvsin - sin(Phi0).*Delta_vv_l_uu - v0(idx_fr).*v0(idx_to).*Delta_sin_u_u - 1/4*(Delta_vv_l_uu+Delta_sin_u_u).^2;
g_Psi7 = Psi_l_vvsin - sin(Phi0).*Delta_vv_l_ll - v0(idx_fr).*v0(idx_to).*Delta_sin_l_l + 1/4*(Delta_vv_l_ll-Delta_sin_l_l).^2;
g_Psi8 = Psi_l_vvsin - sin(Phi0).*Delta_vv_u_uu - v0(idx_fr).*v0(idx_to).*Delta_sin_l_l + 1/4*(Delta_vv_u_uu-Delta_sin_l_l).^2;

g_Psi9 = Psi_u_vv - v_u.^2; %>=0
g_Psi10 = Psi_u_vv - v_l.^2;%>=0
% <= Psi_vv0
g_Psi11 = Psi_l_vv - 2*v0.*Delta_v_u;
g_Psi12 = Psi_l_vv - 2*v0.*Delta_v_l;

g_g1 = g_u_pinj - Cg*pg_opt + Cl*pl_opt; %>=0
g_g2 = g_l_pinj - Cg*pg_opt + Cl*pl_opt; %<=0
g_pgmax = pg_opt + alpha0.*delta_u + slack_pg; %<=pg_max  
g_pgmin = pg_opt + alpha0.*delta_l - slack_pg; %>=pg_min 

g_M1 = M_ineq_minus*[zeros(Nbus,1); Cg*qg_max-Cl*ql_opt;Psi_u_vvcos;Psi_u_vvsin;Psi_u_vv]+M_ineq_plus*[zeros(Nbus,1);Cg*qg_max-Cl*qpq0;Psi_l_vvcos;Psi_l_vvsin;Psi_l_vv]-slack_qg-zeta.*gamma_opt;%>=0
g_M2 = M_ineq_plus*[zeros(Nbus,1); Cg*qg_min-Cl*ql_opt;Psi_u_vvcos;Psi_u_vvsin;Psi_u_vv]+M_ineq_minus*[zeros(Nbus,1);Cg*qg_min-Cl*qpq0;Psi_l_vvcos;Psi_l_vvsin;Psi_l_vv]+slack_qg+zeta.*gamma_opt;%<=0

g_M3 =  M_line_plus *[zeros(2*Nbus,1);Psi_u_vvcos;Psi_u_vvsin;Psi_u_vv]+M_line_minus*[zeros(2*Nbus,1);Psi_l_vvcos;Psi_l_vvsin;Psi_l_vv] - [p_line_fr_u;p_line_to_u;q_line_fr_u;q_line_to_u];%<=0
g_M4 = -M_line_minus*[zeros(2*Nbus,1);Psi_u_vvcos;Psi_u_vvsin;Psi_u_vv]-M_line_plus *[zeros(2*Nbus,1);Psi_l_vvcos;Psi_l_vvsin;Psi_l_vv] - [p_line_fr_u;p_line_to_u;q_line_fr_u;q_line_to_u];%<=0
g_line1 = p_line_fr_u.^2+q_line_fr_u.^2+slack_line.^2;% <= s_line_max.^2
g_line2 = p_line_to_u.^2+q_line_to_u.^2+slack_line.^2;% <= s_line_max.^2

g_K1 = K_plus*[g_u_pinj;-Cl*ql_opt;g_u_vvcos;g_u_vvsin;g_u_vv]+K_minus*[g_l_pinj;-Cl*ql_opt;g_l_vvcos;g_l_vvsin;g_l_vv]+xi.*gamma_opt-[Phi_u;v_u(idx_pq);delta_u;-Phi_l;-v_l(idx_pq);-delta_l];%<=0
g_margin1 = slack_pg - margin_opt;
g_margin2 = slack_qg - margin_opt;
g_margin3 = slack_line -margin_opt;
g_margin4 = gamma_opt - margin_opt;%>=0
g_pgopt = pg_opt+alpha0.*delta_u-pg_opt_u; %<=0 
g_cost = gencost(:,1)'*(pg_opt_u*100).^2+gencost(:,2)'*(pg_opt_u*100)+sum(gencost(:,3))-cost_opt;%<=0

gfun = vertcat(g_v1,g_v2,g_v3,g_Phi1,g_Phi2,g_delta1,g_delta2,g_alpha,g_alpha2,...% Ngen+4*Nbus+8
    g_vv1,g_vv2,g_vv3,g_vv4,g_vv5,g_vv6,g_vv7,g_vv8,g_cos1,g_cos2,g_cos3,g_cos4,g_sin1,g_sin2,g_sin3,g_sin4,...% 8*Nbranch+
    g_gcos11,g_gcos12,g_gcos13,g_gcos14,g_gcos15,g_gcos16,g_gcos17,g_gcos18,...
    g_gcos21,g_gcos22,g_gcos23,g_gcos24,g_gcos25,g_gcos26,g_gcos27,g_gcos28,...
    g_gsin11,g_gsin12,g_gsin13,g_gsin14,g_gsin15,g_gsin16,g_gsin17,g_gsin18,...
    g_gsin21,g_gsin22,g_gsin23,g_gsin24,g_gsin25,g_gsin26,g_gsin27,g_gsin28,...
    g_gsin31,g_gsin32,g_gsin33,g_gsin34,g_gsin35,g_gsin36,g_gsin37,g_gsin38,...
    g_gsin41,g_gsin42,g_gsin43,g_gsin44,g_gsin45,g_gsin46,g_gsin47,g_gsin48,...
    g_gvv1,g_gvv2,g_gvv3,g_gvv4,g_Psi1,g_Psi2,g_Psi3,g_Psi4,g_Psi5,g_Psi6,g_Psi7,g_Psi8,g_Psi9,g_Psi10,g_Psi11,g_Psi12,...% 36+108
    g_g1,g_g2,g_pgmax,g_pgmin,g_M1,g_M2,g_M3,g_M4,g_line1,g_line2,g_K1,...%2*Nbus+2*Ngen+6+72+36
    g_margin1,g_margin2,g_margin3,g_margin4,g_pgopt,g_cost); 

lbg = vertcat(zeros(Ngen,1), v0, v0, Phi0, Phi0, delta0, delta0, alpha0, alpha0, zeros(4*Nbranch,1), -inf(4*Nbranch,1), zeros(2*Nbranch,1), -inf(2*Nbranch,1), zeros(2*Nbranch,1), -inf(2*Nbranch,1),...
    repmat(Psi_vvcos0,8,1),-inf(8*length(Psi_vvcos0),1), repmat(Psi_vvsin0,8,1),repmat(Psi_vvsin0,8,1),-inf(8*length(Psi_vvsin0),1),-inf(8*length(Psi_vvsin0),1),...
    zeros(2*Nbus,1), -inf(2*Nbus,1),  Psi_vvcos0,Psi_vvcos0, -inf(2*Nbranch,1),   Psi_vvsin0,Psi_vvsin0, -inf(2*Nbranch,1),      zeros(2*Nbus,1), -inf(2*Nbus,1),  zeros(Nbus,1),-inf(Nbus,1),...
    -inf(Ngen,1),pg_min, zeros(3,1),-inf(3,1),-inf(8*Nbranch,1),-inf(2*Nbranch,1),        -inf(2*(Nbranch+6+1),1),   zeros(4,1), -inf(Ngen,1),  -inf);
% Define the upper bound of constraints
ubg = vertcat(zeros(Ngen,1),v0,v0,Phi0,Phi0,delta0,delta0,alpha0,alpha0,inf(4*Nbranch,1),zeros(4*Nbranch,1), inf(2*Nbranch,1),zeros(2*Nbranch,1),inf(2*Nbranch,1),zeros(2*Nbranch,1),...
    inf(8*length(Psi_vvcos0),1),repmat(Psi_vvcos0,8,1), inf(8*length(Psi_vvsin0),1),inf(8*length(Psi_vvsin0),1),repmat(Psi_vvsin0,8,1),repmat(Psi_vvsin0,8,1),...
    inf(2*Nbus,1),   Psi_vv0,Psi_vv0, inf(2*Nbranch,1),     Psi_vvcos0,Psi_vvcos0, inf(2*Nbranch,1),       Psi_vvsin0, Psi_vvsin0, inf(2*Nbus,1),   Psi_vv0,Psi_vv0, inf(Nbus,1),zeros(Nbus,1),...
    pg_max,inf(Ngen,1), inf(3,1),zeros(3,1),zeros(8*Nbranch,1),s_line_max.^2,s_line_max.^2,zeros(2*(Nbranch+6+1),1), inf(4,1),   zeros(Ngen,1),   0);

g_add1 = pl_opt;
g_add2 = ql_opt;
g_add3 = margin_opt;
g_add4 = gamma_opt;  
ffun = cost_opt;
gfun = vertcat(gfun,g_add1,g_add2,g_add3,g_add4);
lbg = vertcat(lbg,ppq0,qpq0,0,gamma0);
ubg = vertcat(ubg,ppq0,qpq0,inf,inf);

%options.ipopt.tol         = 1.0e-6;
% options.ipopt.print_level = 5;
% options.print_time        = 5;
% options.ipopt.max_iter    = 100;
opts = struct();
opts.verbose = true;
opts.print_time = true;

qp = struct('x',x,'f',ffun,'g',gfun);    
S = qpsol('solver','qpoases', qp,opts);  
sol = S('x0', x0,'lbg', lbg,'ubg', ubg,...
        'lbx', lbx, 'ubx', ubx);
status = S.stats().return_status;
if strcmp(status, 'Solve_Succeeded')
    mpc.gen(:,PG) = full(sol.x(end-5-4*Ngen-2*Npq:end-5-3*Ngen-2*Npq-1))*mpc.baseMVA;% PG in MW
    mpc.gen(:,end)= full(sol.x(end-5-2*Ngen:end-5-Ngen-1));%alpha_opt in x
    sol_v_u = full(sol.x(1:Nbus));
    mpc.gen(:,VG) = sol_v_u(id_gen);
else
    fprintf('Error in solving the problem: %s\n', status);
end